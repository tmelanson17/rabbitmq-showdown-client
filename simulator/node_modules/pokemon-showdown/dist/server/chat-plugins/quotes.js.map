{
  "version": 3,
  "sources": ["../../../server/chat-plugins/quotes.ts"],
  "sourcesContent": ["import {FS, Utils} from '../../lib';\n\nconst STORAGE_PATH = 'config/chat-plugins/quotes.json';\nconst MAX_QUOTES = 300;\n\ninterface Quote {\n\tuserid: string;\n\tquote: string;\n\tdate: number;\n}\n\nconst quotes: {[room: string]: Quote[]} = JSON.parse(FS(STORAGE_PATH).readIfExistsSync() || \"{}\");\n\n// migrate quotes out of roomsettings\nfunction convertOldQuotes() {\n\tfor (const room of Rooms.rooms.values()) {\n\t\t// @ts-ignore\n\t\tif (room.settings.quotes) {\n\t\t\t// @ts-ignore\n\t\t\tquotes[room.roomid] = room.settings.quotes;\n\t\t\t// @ts-ignore\n\t\t\tdelete room.settings.quotes;\n\t\t\troom.saveSettings();\n\t\t\tsaveQuotes();\n\t\t}\n\t}\n}\n\nfunction saveQuotes() {\n\tFS(STORAGE_PATH).writeUpdate(() => JSON.stringify(quotes));\n}\n\nconvertOldQuotes();\n\nexport const commands: Chat.ChatCommands = {\n\trandquote(target, room, user) {\n\t\troom = this.requireRoom();\n\t\tconst roomQuotes = quotes[room.roomid];\n\t\tif (!roomQuotes?.length) return this.errorReply(`This room has no quotes.`);\n\t\tthis.runBroadcast(true);\n\t\tconst {quote, date, userid} = roomQuotes[Math.floor(Math.random() * roomQuotes.length)];\n\t\tconst time = Chat.toTimestamp(new Date(date), {human: true});\n\t\tconst attribution = toID(target) === 'showauthor' ? `<hr /><small>Added by ${userid} on ${time}</small>` : '';\n\t\treturn this.sendReplyBox(`${Chat.getReadmoreBlock(quote)}${attribution}`);\n\t},\n\trandquotehelp: [`/randquote [showauthor] - Show a random quote from the room. Add 'showauthor' to see who added it and when.`],\n\n\taddquote: 'quote',\n\tquote(target, room, user) {\n\t\troom = this.requireRoom();\n\t\tif (!room.persist) {\n\t\t\treturn this.errorReply(\"This command is unavailable in temporary rooms.\");\n\t\t}\n\t\ttarget = target.trim();\n\t\tthis.checkCan('mute', null, room);\n\t\tif (!target) {\n\t\t\treturn this.parse(`/help quote`);\n\t\t}\n\t\tif (!quotes[room.roomid]) quotes[room.roomid] = [];\n\n\t\tconst roomQuotes = quotes[room.roomid];\n\t\tif (this.filter(target) !== target) {\n\t\t\treturn this.errorReply(`Invalid quote.`);\n\t\t}\n\t\tif (roomQuotes.filter(item => item.quote === target).length) {\n\t\t\treturn this.errorReply(`\"${target}\" is already quoted in this room.`);\n\t\t}\n\t\tif (target.length > 8192) {\n\t\t\treturn this.errorReply(`Your quote cannot exceed 8192 characters.`);\n\t\t}\n\t\tif (room.settings.isPrivate && roomQuotes.length >= MAX_QUOTES) {\n\t\t\treturn this.errorReply(`This room already has ${MAX_QUOTES} quotes, which is the maximum for private rooms.`);\n\t\t}\n\t\troomQuotes.push({userid: user.id, quote: target, date: Date.now()});\n\t\tsaveQuotes();\n\t\tthis.refreshPage(`quotes-${room.roomid}`);\n\t\tconst collapsedQuote = target.replace(/\\n/g, ' ');\n\t\tthis.privateModAction(`${user.name} added a new quote: \"${collapsedQuote}\".`);\n\t\treturn this.modlog(`ADDQUOTE`, null, collapsedQuote);\n\t},\n\tquotehelp: [`/quote [quote] - Adds [quote] to the room's quotes. Requires: % @ # &`],\n\n\tremovequote(target, room, user) {\n\t\troom = this.requireRoom();\n\t\tthis.checkCan('mute', null, room);\n\t\tif (!quotes[room.roomid]?.length) return this.errorReply(`This room has no quotes.`);\n\t\tconst index = parseInt(target.trim());\n\t\tif (isNaN(index)) {\n\t\t\treturn this.errorReply(`Invalid index.`);\n\t\t}\n\t\tconst roomQuotes = quotes[room.roomid];\n\t\tif (!roomQuotes[index - 1]) {\n\t\t\treturn this.errorReply(`Quote not found.`);\n\t\t}\n\t\tconst [removed] = roomQuotes.splice(index - 1, 1);\n\t\tconst collapsedQuote = removed.quote.replace(/\\n/g, ' ');\n\t\tthis.privateModAction(`${user.name} removed quote indexed at ${index}: \"${collapsedQuote}\" (originally added by ${removed.userid}).`);\n\t\tthis.modlog(`REMOVEQUOTE`, null, collapsedQuote);\n\t\tsaveQuotes();\n\t\tthis.refreshPage(`quotes-${room.roomid}`);\n\t},\n\tremovequotehelp: [`/removequote [index] - Removes the quote from the room's quotes. Requires: % @ # &`],\n\n\tviewquote(target, room, user) {\n\t\troom = this.requireRoom();\n\t\tconst roomQuotes = quotes[room.roomid];\n\t\tif (!roomQuotes?.length) return this.errorReply(`This room has no quotes.`);\n\t\tconst [num, showAuthor] = Utils.splitFirst(target, ',');\n\t\tconst index = parseInt(num) - 1;\n\t\tif (isNaN(index)) {\n\t\t\treturn this.errorReply(`Invalid index.`);\n\t\t}\n\t\tif (!roomQuotes[index]) {\n\t\t\treturn this.errorReply(`Quote not found.`);\n\t\t}\n\t\tthis.runBroadcast(true);\n\t\tconst {quote, date, userid} = roomQuotes[index];\n\t\tconst time = Chat.toTimestamp(new Date(date), {human: true});\n\t\tconst attribution = toID(showAuthor) === 'showauthor' ? `<hr /><small>Added by ${userid} on ${time}</small>` : '';\n\t\treturn this.sendReplyBox(`${Chat.formatText(quote, false, true)}${attribution}`);\n\t},\n\tviewquotehelp: [\n\t\t`/viewquote [index][, params] - View the quote from the room's quotes.`,\n\t\t`If 'showauthor' is used for the [params] argument, it shows who added the quote and when.`,\n\t\t`Requires: % @ # &`,\n\t],\n\n\tviewquotes: 'quotes',\n\tquotes(target, room) {\n\t\tconst targetRoom = target ? Rooms.search(target) : room;\n\t\tif (!targetRoom) return this.errorReply(`Invalid room.`);\n\t\tthis.parse(`/join view-quotes-${targetRoom.roomid}`);\n\t},\n\tquoteshelp: [`/quotes [room] - Shows all quotes for [room]. Defaults the room the command is used in.`],\n};\n\nexport const pages: Chat.PageTable = {\n\tquotes(args, user) {\n\t\tconst room = this.requireRoom();\n\t\tthis.title = `[Quotes]`;\n\t\t// allow it for users if they can access the room\n\t\tif (!room.checkModjoin(user)) {\n\t\t\treturn this.errorReply(`Access denied.`);\n\t\t}\n\t\tlet buffer = `<div class=\"pad\">`;\n\t\tbuffer += `<button style=\"float:right;\" class=\"button\" name=\"send\" value=\"/join view-quotes-${room.roomid}\"><i class=\"fa fa-refresh\"></i> Refresh</button>`;\n\n\t\tconst roomQuotes = quotes[room.roomid];\n\t\tif (!roomQuotes?.length) {\n\t\t\treturn `${buffer}<h2>This room has no quotes.</h2></div>`;\n\t\t}\n\n\t\tbuffer += Utils.html`<h2>Quotes for ${room.title} (${roomQuotes.length}):</h2>`;\n\t\tfor (const [i, quoteObj] of roomQuotes.entries()) {\n\t\t\tconst index = i + 1;\n\t\t\tconst {quote, userid, date} = quoteObj;\n\t\t\tbuffer += `<div class=\"infobox\">#${index}: ${Chat.formatText(quote, false, true)}`;\n\t\t\tbuffer += `<br /><hr /><small>Added by ${userid} on ${Chat.toTimestamp(new Date(date), {human: true})}</small>`;\n\t\t\tif (user.can('mute', null, room)) {\n\t\t\t\tbuffer += ` <button class=\"button\" name=\"send\" value=\"/msgroom ${room.roomid},/removequote ${index}\">Remove</button>`;\n\t\t\t}\n\t\t\tbuffer += `</div>`;\n\t\t}\n\t\tbuffer += `</div>`;\n\t\treturn buffer;\n\t},\n};\n\nexport const handlers: Chat.Handlers = {\n\tonRenameRoom(oldID, newID) {\n\t\tif (quotes[oldID]) {\n\t\t\tif (!quotes[newID]) quotes[newID] = [];\n\t\t\tquotes[newID].push(...quotes[oldID]);\n\t\t\tdelete quotes[oldID];\n\t\t\tsaveQuotes();\n\t\t}\n\t},\n};\n"],
  "mappings": "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",
  "names": []
}
